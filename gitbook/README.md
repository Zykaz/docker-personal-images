# gitbook

## Introduction

A customized image for gitbook based on node:12.16.1.


### Featrues

- Basic `gitbook` command line.
- Support customizing favicon.ico of static sites.
- Support making PDF (by full version)
- Support PDF 中文編碼 (using [Google Noto Sans CJK TC](https://www.google.com/get/noto/#sans-hant))


### Environment information

```bash
root@bc3df8ddf34b:/gitbook# gitbook --version
CLI version: 2.3.2
GitBook version: 3.2.3
# node -v
v12.16.1
# npx -v
6.13.4
# npm -v
6.13.4
root@bc3df8ddf34b:/gitbook#
```

### Full version vs. Light version

There are 2 versions for different purposes:

| Version | Image Size | Description                         |
|:-------:|:----------:|:------------------------------------|
| light   | 1.18GB     | Support Static Sites building.       |
| full    | 2.09GB     | Support Static Sites & PDF building. |



## Quick Start

```bash
$ cd book_sources_example   # folder of your book
$ docker run --rm -p 4000:4000 -v $(pwd):/gitbook onejar99/gitbook:light "gitbook init && gitbook install && gitbook build"
$ docker run --rm -p 4000:4000 -v $(pwd):/gitbook onejar99/gitbook:full "gitbook init && gitbook install && gitbook pdf"
```


## User Guide

> NOTE: `README.md` is required, even it's empty. (can be generated by `gitbook init`)


### 1. Build Static Sites

Build a static site:
```bash
$ cd book_sources_example   # the folder of your book
$ docker run --rm -p 4000:4000 -v $(pwd):/gitbook onejar99/gitbook:light "gitbook init"
$ docker run --rm -p 4000:4000 -v $(pwd):/gitbook onejar99/gitbook:light "gitbook install && gitbook build"
```

Output files will be in `$(pwd)/_book` folder.

Verify the site with a light web server:
```bash
$ docker run --rm  -p 4000:8080 -v $(pwd)/_book:/home/app/public onejar99/nodejs-live-server:node12.16.1
```
and then visit http://localhost:4000.


You can customize following files:
- `book.json`: customize gitbook plugins configuration by your requirements.
- `favicon.ico`: (optional) static site's favicon.


Result Demo:
![](./figures/i_imgur_com_L8WJlNr.png)


### 2. Build PDF (by full version)

Build a PDF book:

```bash
$ cd book_sources_example   # the folder of your book
$ docker run --rm -p 4000:4000 -v $(pwd):/gitbook onejar99/gitbook:full "gitbook init"
# by default, pdf file named "book.pdf"
$ docker run --rm -p 4000:4000 -v $(pwd):/gitbook onejar99/gitbook:full "gitbook install && gitbook pdf"
# specify pdf file name as "mybook.pdf"
$ docker run --rm -p 4000:4000 -v $(pwd):/gitbook onejar99/gitbook:full "gitbook install && gitbook pdf ./ mybook.pdf"
```

You can customize following files:
- `cover.jpg`: (optional) cover of output PDF.


Result Demo:

![](./figures/i_imgur_com_yTkc7O0.png)


### 3. Serving By Development Mode (`gitbook serve`)

```bash
$ cd book_sources_example   # the folder of your book
$ docker run --rm -ti -p 4000:4000 -v $(pwd):/gitbook onejar99/gitbook:light /bin/bash
root@09d781d735bd:/gitbook# gitbook install
root@09d781d735bd:/gitbook# gitbook serve
```
and then visit http://localhost:4000.


### 4. Serving Directly (Not Recommended)

```bash
$ cd book_sources_example   # the folder of your book
$ docker run --rm -p 4000:4000 -v $(pwd):/gitbook onejar99/gitbook:light "gitbook init"
$ docker run --rm -p 4000:4000 -v $(pwd):/gitbook onejar99/gitbook:light "gitbook install"
$ docker run --rm -p 4000:4000 -v $(pwd):/gitbook onejar99/gitbook:light "gitbook serve"
```
and then visit http://localhost:4000.

> NOTE: Because the container cannot receive the signal of Ctrl + C, you must terminate it by `docker stop`. That's why this usage is not recommended.

```bash
# assume container id is 1b78785665e7
$ docker stop 1b78785665e7
```


## Build & Release

### light version

```bash
$ cd tag__light
$ majorTag=light && buildTag=${majorTag}_$(date +"%Y%m%d") && echo $buildTag \
&& docker build -t onejar99/gitbook:${buildTag} . \
&& docker image tag onejar99/gitbook:${buildTag} onejar99/gitbook:${majorTag} \
&& docker push onejar99/gitbook:${buildTag} \
&& docker push onejar99/gitbook:${majorTag}
```

### full version

```bash
$ cd tag__full
$ majorTag=full && buildTag=${majorTag}_$(date +"%Y%m%d") && echo $buildTag \
&& docker build -t onejar99/gitbook:${buildTag} . \
&& docker image tag onejar99/gitbook:${buildTag} onejar99/gitbook:${majorTag} \
&& docker push onejar99/gitbook:${buildTag} \
&& docker push onejar99/gitbook:${majorTag}
```

## References

Inspired by:
- https://github.com/billryan/docker-gitbook/tree/base
- https://github.com/puritys/personal-docker/tree/master/gitbook

About this image:
- Docker Repository: https://hub.docker.com/r/onejar99/gitbook/tags
- GitHub: https://github.com/onejar99/docker-personal-images/tree/master/gitbook


## Appendix: Fixed Issues

Record the course of issue fixing.

### [Issue] Errors sometimes when run `gitbook build` or `gitbook serve`

#### Situation

有時候 gitbook build 或 gitbook serve 會出現以下 error:
```bash
Error: ENOENT: no such file or directory, stat '/gitbook/_book/gitbook/gitbook-plugin-fontsettings/fontsettings.js'
# or
Error: ENOENT: no such file or directory, stat '/gitbook/_book/gitbook/gitbook-plugin-lunr/lunr.min.js'
# or
Error: ENOENT: no such file or directory, stat '/gitbook/_book/gitbook/gitbook-plugin-highlight/ebook.css'
# or
Error: ENOENT: no such file or directory, stat '/gitbook/_book/gitbook/gitbook-plugin-sharing/buttons.js'
# and so on
```

例如：

```bash
$ docker run --rm -ti -p 5003:4000 -v $(pwd):/gitbook onejar99/gitbook:light "gitbook build"
info: 9 plugins are installed
info: 8 explicitly listed
info: loading plugin "back-to-top-button"... OK
info: loading plugin "intopic-toc"... OK
info: loading plugin "highlight"... OK
info: loading plugin "search"... OK
info: loading plugin "lunr"... OK
info: loading plugin "sharing"... OK
info: loading plugin "fontsettings"... OK
info: loading plugin "theme-default"... OK
info: found 5 pages
info: found 268 asset files

Error: ENOENT: no such file or directory, stat '/gitbook/_book/gitbook/gitbook-plugin-fontsettings/fontsettings.js'
$
```

再執行一次可能就能過，但出現頻率有點高，測試 failure ratio 超過 50% (13/20)，以工具來說太不穩定。


#### Solution

似乎是 gitbook 3.2.3 的 bug，網友推薦低版本 Node V6 和 gitbook 2.6.7~2.6.4。
後來以 try to fix 2 解決，測試 failure ratio: 0/10。


**[try to fix 1] fix cpr@3 on node:12.16.1 (not work)**
```
Bug in confirm: true is fixed in cpr@3 (davglass/cpr#57), but gitbook still depends on cpr@1.

Installation of patched cpr using gitbook's npm:

cd ~/.gitbook/versions/3.2.3
npx npm install cpr@3
```

**[try to fix 2] fix copyPluginAssets.js**

```bash
## vim /root/.gitbook/versions/<gitbook-version>/lib/output/website/copyPluginAssets.js
$ vim /root/.gitbook/versions/3.2.3/lib/output/website/copyPluginAssets.js
```
line 112 的 `confirm: true` 改 `confirm: false`:
```js
    logger.debug.ln('copy resources from plugin', assetsFolder);

    return fs.copyDir(
        assetsFolder,
        assetOutputFolder,
        {
            deleteFirst: false,
            overwrite: true,
            confirm: true // <--- here
        }
    );
```

#### References

- [gitbook serve error with ENOENT: no such file or directory(fontsettings.js&website.css) · Issue #55 · GitbookIO/gitbook-cli · GitHub](https://github.com/GitbookIO/gitbook-cli/issues/55)
- [gitbook serve命令找不到fontsettings.js - segmentfault](https://segmentfault.com/q/1010000009569245)
